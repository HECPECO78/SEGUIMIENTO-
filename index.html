<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento Alumnos - Rotaci√≥n Talleres</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #f5f3ff 0%, #e0e7ff 100%);
        min-height: 100vh;
        padding: 20px;
        line-height: 1.5;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .sync-status {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 13px;
        z-index: 2000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .sync-status.syncing {
        background: #f59e0b;
    }

    .sync-status.error {
        background: #ef4444;
    }

    .header {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .header-title h1 {
        color: #4f46e5;
        font-size: 28px;
        margin-bottom: 5px;
    }

    .header-title p {
        color: #6b7280;
        font-size: 14px;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #4f46e5;
        color: white;
    }

    .btn-primary:hover {
        background: #4338ca;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-warning {
        background: #f59e0b;
        color: white;
    }

    .btn-warning:hover {
        background: #d97706;
    }

    .btn-secondary {
        background: #e5e7eb;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #d1d5db;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .form-nuevo {
        background: #eef2ff;
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
    }

    .form-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .form-row input,
    .form-row select {
        flex: 1;
        min-width: 150px;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
    }

    .main-content {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
    }

    @media (max-width: 1024px) {
        .main-content {
            grid-template-columns: 1fr;
        }
    }

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .alumnos-group {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 15px;
    }

    .alumnos-group h3 {
        color: #312e81;
        margin-bottom: 10px;
        font-size: 16px;
    }

    .alumno-btn {
        width: 100%;
        padding: 10px;
        background: #f9fafb;
        border: none;
        border-radius: 8px;
        text-align: left;
        cursor: pointer;
        margin-bottom: 5px;
        transition: all 0.3s;
    }

    .alumno-btn:hover {
        background: #f3f4f6;
    }

    .alumno-btn.active {
        background: #eef2ff;
        color: #4f46e5;
        font-weight: 600;
    }

    .content-area {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 20px;
    }

    .placeholder {
        text-align: center;
        padding: 80px 20px;
        color: #9ca3af;
    }

    .placeholder svg {
        width: 64px;
        height: 64px;
        margin: 0 auto 20px;
        opacity: 0.3;
    }

    .alumno-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 20px;
    }

    .alumno-info h2 {
        font-size: 22px;
        margin-bottom: 5px;
    }

    .alumno-info p {
        color: #4f46e5;
        font-size: 14px;
    }

    .btn-delete {
        background: #ef4444;
        color: white;
        padding: 8px 12px;
    }

    .btn-delete:hover {
        background: #dc2626;
    }

    .semanas-nav {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-bottom: 20px;
    }

    .semana-btn {
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        background: #f3f4f6;
        transition: all 0.3s;
    }

    .semana-btn.active {
        background: #4f46e5;
        color: white;
    }

    .dias-header {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
        margin-bottom: 15px;
    }

    .dia-label {
        text-align: center;
        font-weight: 600;
        background: #f9fafb;
        padding: 10px;
        border-radius: 8px;
        font-size: 13px;
    }

    .categoria {
        margin-bottom: 15px;
    }

    .categoria-header {
        background: #eef2ff;
        padding: 12px 15px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 14px;
    }

    .categoria-content {
        display: none;
        padding-top: 10px;
    }

    .categoria-content.expanded {
        display: block;
    }

    .aspecto {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .aspecto-nombre {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .aspecto-dias {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
    }

    .aspecto-dias select {
        width: 100%;
        padding: 6px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 12px;
    }

    .notas-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 20px;
        margin-top: 20px;
    }

    .notas-section h3 {
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 14px;
    }

    .notas-input {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .notas-input input {
        flex: 1;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
    }

    .notas-lista {
        max-height: 150px;
        overflow-y: auto;
    }

    .nota-item {
        background: #fef3c7;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        font-size: 13px;
    }

    .nota-fecha {
        color: #6b7280;
        font-size: 11px;
        margin-top: 5px;
    }

    .comentarios-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 20px;
        margin-top: 20px;
    }

    .comentarios-btns {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .btn-comentario {
        padding: 15px;
        background: #4f46e5;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-comentario:hover {
        background: #4338ca;
    }

    .btn-comentario.mensual {
        background: #7c3aed;
    }

    .btn-comentario.mensual:hover {
        background: #6d28d9;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 800px;
        width: 100%;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        font-size: 18px;
    }

    .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .modal-body pre {
        white-space: pre-wrap;
        font-size: 13px;
        font-family: inherit;
        line-height: 1.6;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
    }

    .tareas-section {
        background: #f9fafb;
        border-radius: 12px;
        padding: 15px;
        margin-top: 15px;
    }

    .tareas-toggle {
        background: #eef2ff;
        padding: 12px 15px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .tareas-content {
        display: none;
    }

    .tareas-content.expanded {
        display: block;
    }

    .taller-group {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 2px solid #e5e7eb;
    }

    .taller-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .taller-titulo {
        font-size: 16px;
        font-weight: 600;
        color: #4f46e5;
    }

    .tarea-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .tarea-titulo {
        font-weight: 600;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
    }

    .tarea-criterios {
        font-size: 12px;
        color: #6b7280;
        margin-top: 5px;
    }

    .criterio-tag {
        display: inline-block;
        background: #eef2ff;
        color: #4f46e5;
        padding: 3px 8px;
        border-radius: 4px;
        margin: 2px;
        font-size: 11px;
    }

    .form-tarea {
        background: #eef2ff;
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
    }

    .form-group {
        margin-bottom: 10px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 13px;
        font-weight: 500;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
    }

    .criterios-inputs {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .rotacion-section {
        background: #fef3c7;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 2px solid #f59e0b;
    }

    .rotacion-label {
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
        font-size: 14px;
        color: #92400e;
    }

    .rotacion-select {
        width: 100%;
        padding: 10px;
        border: 2px solid #f59e0b;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        background: white;
        margin-bottom: 10px;
    }

    .tarea-select-section {
        background: #dbeafe;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
    }

    .tarea-select-label {
        font-weight: 600;
        margin-bottom: 6px;
        display: block;
        font-size: 13px;
        color: #1e40af;
    }

    .tarea-select {
        width: 100%;
        padding: 8px;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
    }

    .info-banner {
        background: #dbeafe;
        border-left: 4px solid #3b82f6;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 13px;
    }

    .desplegable-tipo {
        margin-bottom: 15px;
    }

    .desplegable-header {
        background: #f8fafc;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 13px;
        border: 1px solid #e2e8f0;
    }

    .desplegable-content {
        display: none;
        padding-top: 10px;
    }

    .desplegable-content.expanded {
        display: block;
    }
</style>
```

</head>
<body>
    <div class="sync-status" id="sync-status">üîÑ Conectando...</div>

```
<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="header-top">
            <div class="header-title">
                <h1>üîÑ Seguimiento - Rotaci√≥n de Talleres</h1>
                <p id="contador-alumnos">0 alumnos</p>
            </div>
            <div class="header-buttons">
                <button class="btn btn-warning" onclick="cargarTodasActividades()">
                    üî• Cargar Todas
                </button>
                <button class="btn btn-primary" onclick="toggleFormTareas()">
                    üîß Ver Tareas
                </button>
                <button class="btn btn-primary" onclick="toggleFormNuevo()">
                    ‚ûï Alumno
                </button>
                <button class="btn btn-success" onclick="exportar()" id="btn-exportar">
                    üíæ Exportar
                </button>
            </div>
        </div>

        <!-- Formulario gesti√≥n tareas (colapsable) -->
        <div id="form-tareas" style="display: none;">
            <div class="tareas-section">
                <div class="tareas-toggle" onclick="toggleTareasContent()">
                    <span>üìã Banco de Tareas por Taller</span>
                    <span id="tareas-arrow">‚ñº</span>
                </div>
                
                <div class="tareas-content" id="tareas-content">
                    <div id="form-nueva-tarea" style="display: none;">
                        <div class="form-tarea">
                            <div class="form-group">
                                <label>Taller:</label>
                                <select id="nueva-tarea-taller">
                                    <option>Electricidad</option>
                                    <option>Fontaner√≠a</option>
                                    <option>Carpinter√≠a</option>
                                    <option>Alba√±iler√≠a</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Nombre de la tarea:</label>
                                <input type="text" id="nueva-tarea-nombre" placeholder="Ej: Instalaci√≥n de enchufes">
                            </div>
                            <div class="form-group">
                                <label>Criterios de evaluaci√≥n:</label>
                                <div class="criterios-inputs" id="criterios-inputs">
                                    <input type="text" placeholder="Criterio 1" class="criterio-input">
                                    <input type="text" placeholder="Criterio 2" class="criterio-input">
                                    <input type="text" placeholder="Criterio 3" class="criterio-input">
                                </div>
                                <button class="btn btn-secondary btn-small" style="margin-top: 5px;" onclick="agregarCriterioInput()">+ A√±adir criterio</button>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="guardarTarea()">Guardar Tarea</button>
                                <button class="btn btn-secondary" onclick="toggleFormNuevaTarea()">Cancelar</button>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-small" style="margin-bottom: 15px;" onclick="toggleFormNuevaTarea()">‚ûï Nueva Tarea Manual</button>

                    <div id="lista-tareas"></div>
                </div>
            </div>
        </div>

        <!-- Formulario nuevo alumno -->
        <div id="form-nuevo" class="form-nuevo" style="display: none;">
            <div class="form-row">
                <input type="text" id="nombre-nuevo" placeholder="Nombre del alumno" onkeypress="if(event.key==='Enter')agregarAlumno()">
                <button class="btn btn-primary" onclick="agregarAlumno()">Agregar</button>
                <button class="btn btn-secondary" onclick="toggleFormNuevo()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="alumnos-group">
                <h3>üë• Alumnos</h3>
                <div id="lista-alumnos"></div>
            </div>
        </div>

        <!-- Content Area -->
        <div id="content-area">
            <div class="content-area">
                <div class="placeholder">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p>Selecciona un alumno para comenzar el seguimiento</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Comentario -->
<div id="modal-comentario" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìÑ Comentario</h3>
            <button class="btn-close" onclick="cerrarModal()">&times;</button>
        </div>
        <div class="modal-body">
            <pre id="texto-comentario"></pre>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" style="width: 100%;" onclick="copiarComentario()">üìã Copiar al Portapapeles</button>
        </div>
    </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBCbj2orvoo7rF7a3RwsDM_3SSQq_3gJyw",
        authDomain: "seguimiento-cb339.firebaseapp.com",
        databaseURL: "https://seguimiento-cb339-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "seguimiento-cb339",
        storageBucket: "seguimiento-cb339.firebasestorage.app",
        messagingSenderId: "683813548226",
        appId: "1:683813548226:web:5176bb425b17e9aa2e8b5b"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Export to window for global access
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseGet = get;
    window.firebaseOnValue = onValue;
    window.firebaseRemove = remove;

    // Initialize app after Firebase is ready
    window.inicializarApp();
</script>

<script>
    // Variables globales
    let alumnos = [];
    let tareas = [];
    let notas = {};
    let seleccionado = null;
    let semanaActual = 1;
    let categoriaExpandida = 'actitudinales';
    let tareasExpanded = false;
    let firebaseInitialized = false;

    const talleres = ['Electricidad', 'Fontaner√≠a', 'Carpinter√≠a', 'Alba√±iler√≠a'];

    // Datos de actividades (mantenidos del c√≥digo original)
    const actividadesElectricidadOriginal = [
        {
            nombre: "ACT1: Herramientas b√°sicas (destornilladores, alicates, pelacables)",
            criterios: [
                "Identificaci√≥n correcta de herramientas",
                "T√©cnica de uso de destornilladores",
                "Manejo de alicates y pelacables",
                "Pelado y preparaci√≥n de cables",
                "Mantenimiento de herramientas"
            ]
        },
        {
            nombre: "ACT2: Instrumentos de medida (volt√≠metro, amper√≠metro)",
            criterios: [
                "Uso correcto del mult√≠metro",
                "Medici√≥n de tensi√≥n y corriente",
                "Pruebas de continuidad",
                "Uso de pinzas amperim√©tricas",
                "Interpretaci√≥n de medidas"
            ]
        }
    ];

    const actividadesFontaneriaOriginal = [
        {
            nombre: "ACT1: Herramientas de fontaner√≠a (llaves, cortatubos, soplete)",
            criterios: [
                "Identificaci√≥n correcta de herramientas",
                "Uso de llaves inglesas y estilson",
                "T√©cnica de corte de tubos",
                "Manejo de soplete para soldadura",
                "Mantenimiento de herramientas"
            ]
        }
    ];

    const actividadesCarpinteriaOriginal = [
        {
            nombre: "ACT1: Herramientas manuales (sierras, cepillos, formones)",
            criterios: [
                "Identificaci√≥n correcta de herramientas",
                "T√©cnica de corte con sierras",
                "Uso de cepillos para cepillado",
                "Manejo de formones para ensambles",
                "Afilado y mantenimiento"
            ]
        }
    ];

    const actividadesAlbanileriaOriginal = [
        {
            nombre: "ACT1: Herramientas de alba√±iler√≠a (paletas, niveles, plomadas)",
            criterios: [
                "Identificaci√≥n correcta de herramientas",
                "Uso de paletas para mortero",
                "Manejo de niveles y plomadas",
                "T√©cnicas de aplomado",
                "Limpieza y mantenimiento"
            ]
        }
    ];

    const aspectosData = [
        {
            categoria: 'actitudinales',
            titulo: 'üë§ Actitudinales',
            items: [
                {
                    nombre: 'Puntualidad',
                    opciones: ['', 'üïê A la hora', 'üïï Retraso 5-10m', '‚è≥ Tarde +10m', '‚åõ Falta just', '‚õî Falta no just']
                },
                {
                    nombre: 'Actitud',
                    opciones: ['', 'üåü Proactivo', '‚úÖ Positiva', 'üòê Pasivo', 'üòû Desmotivado', '‚ûñ No observado']
                },
                {
                    nombre: 'Trabajo equipo',
                    opciones: ['', 'ü§ù Colabora', '‚úÖ Bien', 'üôã Solo', '‚ö†Ô∏è Conflictos', '‚ûñ No observado']
                }
            ]
        },
        {
            categoria: 'progreso',
            titulo: 'üìà Progreso',
            items: [
                {
                    nombre: 'Evoluci√≥n',
                    opciones: ['', 'üöÄ Mejora notable', '‚úÖ Al ritmo', 'üêå Lento', 'üîÑ Estancado', '‚ûñ No observado']
                },
                {
                    nombre: 'Autonom√≠a',
                    opciones: ['', 'üí™ Independiente', '‚úÖ Poca super', 'üôã Pregunta mucho', 'üë®‚Äçüè´ Acompa√±amiento', '‚ûñ No observado']
                },
                {
                    nombre: 'Resoluci√≥n problemas',
                    opciones: ['', 'üß© Solo', '‚úÖ Con ayuda', 'ü§î Se bloquea', 'üÜò No sabe', '‚ûñ No observado']
                }
            ]
        }
    ];

    // Sistema de sincronizaci√≥n con Firebase
    function mostrarEstadoSync(mensaje, tipo = 'success') {
        const status = document.getElementById('sync-status');
        status.textContent = mensaje;
        status.className = 'sync-status';
        if (tipo === 'syncing') status.classList.add('syncing');
        if (tipo === 'error') status.classList.add('error');
    }

    function guardarEnFirebase() {
        if (!firebaseInitialized) return;
        
        try {
            const data = {
                alumnos: alumnos,
                notas: notas,
                tareas: tareas,
                ultimaActualizacion: new Date().toISOString()
            };
            
            mostrarEstadoSync('‚è≥ Guardando...', 'syncing');
            window.firebaseSet(window.firebaseRef(window.firebaseDB, 'seguimiento'), data)
                .then(() => {
                    mostrarEstadoSync('‚úÖ Sincronizado');
                    setTimeout(() => {
                        mostrarEstadoSync('üîÑ Conectado');
                    }, 2000);
                })
                .catch(error => {
                    console.error('Error guardando:', error);
                    mostrarEstadoSync('‚ùå Error al guardar', 'error');
                });
        } catch (e) {
            console.error('Error:', e);
        }
    }

    function cargarDesdeFirebase() {
        if (!firebaseInitialized) return;
        
        try {
            const dbRef = window.firebaseRef(window.firebaseDB, 'seguimiento');
            
            window.firebaseOnValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    alumnos = data.alumnos || [];
                    notas = data.notas || {};
                    tareas = data.tareas || [];
                    renderizar();
                    mostrarEstadoSync('‚úÖ Datos actualizados');
                    setTimeout(() => {
                        mostrarEstadoSync('üîÑ Conectado');
                    }, 2000);
                }
            }, {
                onlyOnce: false
            });
        } catch (e) {
            console.error('Error cargando:', e);
            mostrarEstadoSync('‚ùå Error conexi√≥n', 'error');
        }
    }

    // Inicializaci√≥n
    window.inicializarApp = function() {
        firebaseInitialized = true;
        mostrarEstadoSync('üîÑ Conectando...', 'syncing');
        cargarDesdeFirebase();
    };

    function crearSeguimiento() {
        const seg = {};
        for (let s = 1; s <= 4; s++) {
            seg['s' + s] = {
                taller: null,
                tareaAsignada: null,
                dias: {}
            };
            for (let d = 1; d <= 5; d++) {
                seg['s' + s].dias['d' + d] = {
                    tarea: {},
                    actitudinales: {},
                    progreso: {}
                };
                
                aspectosData.forEach(cat => {
                    cat.items.forEach((item, idx) => {
                        seg['s' + s].dias['d' + d][cat.categoria][idx] = '';
                    });
                });
            }
        }
        return seg;
    }

    function toggleFormNuevo() {
        const form = document.getElementById('form-nuevo');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function toggleFormTareas() {
        const form = document.getElementById('form-tareas');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
        if (form.style.display === 'block') {
            renderizarTareas();
        }
    }

    function toggleTareasContent() {
        tareasExpanded = !tareasExpanded;
        const content = document.getElementById('tareas-content');
        const arrow = document.getElementById('tareas-arrow');
        content.classList.toggle('expanded');
        arrow.textContent = tareasExpanded ? '‚ñ≤' : '‚ñº';
    }

    function toggleFormNuevaTarea() {
        const form = document.getElementById('form-nueva-tarea');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function agregarCriterioInput() {
        const container = document.getElementById('criterios-inputs');
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'criterio-input';
        input.placeholder = 'Criterio ' + (container.children.length + 1);
        container.appendChild(input);
    }

    function guardarTarea() {
        const taller = document.getElementById('nueva-tarea-taller').value;
        const nombre = document.getElementById('nueva-tarea-nombre').value.trim();
        const inputs = document.querySelectorAll('.criterio-input');
        const criterios = [];
        inputs.forEach(inp => {
            if (inp.value.trim()) {
                criterios.push(inp.value.trim());
            }
        });

        if (!nombre) {
            alert('Por favor, ingresa un nombre para la tarea');
            return;
        }

        if (criterios.length === 0) {
            alert('Por favor, a√±ade al menos un criterio de evaluaci√≥n');
            return;
        }

        tareas.push({
            id: Date.now(),
            taller: taller,
            nombre: nombre,
            criterios: criterios,
            tipo: 'manual'
        });

        guardarEnFirebase();
        toggleFormNuevaTarea();
        renderizarTareas();
    }

    function eliminarTarea(id) {
        if (confirm('¬øEliminar esta tarea?')) {
            tareas = tareas.filter(t => t.id !== id);
            guardarEnFirebase();
            renderizarTareas();
        }
    }

    function cargarTodasActividades() {
        if (confirm('¬øCargar actividades predefinidas? Esto a√±adir√° actividades de ejemplo.')) {
            const todosTalleres = [
                { taller: 'Electricidad', originales: actividadesElectricidadOriginal },
                { taller: 'Fontaner√≠a', originales: actividadesFontaneriaOriginal },
                { taller: 'Carpinter√≠a', originales: actividadesCarpinteriaOriginal },
                { taller: 'Alba√±iler√≠a', originales: actividadesAlbanileriaOriginal }
            ];

            let totalAgregadas = 0;
            todosTalleres.forEach(tallerData => {
                tallerData.originales.forEach(act => {
                    const existe = tareas.find(t => t.nombre === act.nombre && t.taller === tallerData.taller);
                    if (!existe) {
                        tareas.push({
                            id: Date.now() + totalAgregadas,
                            taller: tallerData.taller,
                            nombre: act.nombre,
                            criterios: act.criterios,
                            tipo: 'original'
                        });
                        totalAgregadas++;
                    }
                });
            });

            guardarEnFirebase();
            alert(`‚úÖ Se han agregado ${totalAgregadas} actividades`);
            renderizarTareas();
        }
    }

    function renderizarTareas() {
        const lista = document.getElementById('lista-tareas');
        
        if (tareas.length === 0) {
            lista.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No hay tareas. Haz clic en "Cargar Todas" para a√±adir actividades.</p>';
            return;
        }

        const tareasPorTaller = {};
        talleres.forEach(t => tareasPorTaller[t] = []);
        tareas.forEach(t => {
            if (tareasPorTaller[t.taller]) {
                tareasPorTaller[t.taller].push(t);
            }
        });

        lista.innerHTML = talleres.map(taller => {
            const tareasDelTaller = tareasPorTaller[taller];
            if (tareasDelTaller.length === 0) return '';
            
            return `
                <div class="taller-group">
                    <div class="taller-header">
                        <div class="taller-titulo">üîß ${taller}</div>
                        <div style="color: #6b7280; font-size: 13px;">${tareasDelTaller.length} tareas</div>
                    </div>
                    ${tareasDelTaller.map(t => `
                        <div class="tarea-item">
                            <div class="tarea-titulo">
                                <span>${t.nombre}</span>
                                <button class="btn btn-danger btn-small" onclick="eliminarTarea(${t.id})">üóëÔ∏è</button>
                            </div>
                            <div class="tarea-criterios">
                                ${t.criterios.map(c => `<span class="criterio-tag">${c}</span>`).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }).join('');
    }

    function agregarAlumno() {
        const nombre = document.getElementById('nombre-nuevo').value.trim();
        if (!nombre) return;

        alumnos.push({
            id: Date.now(),
            nombre: nombre,
            seg: crearSeguimiento()
        });

        document.getElementById('nombre-nuevo').value = '';
        guardarEnFirebase();
        renderizar();
        toggleFormNuevo();
    }

    function eliminarAlumno(id) {
        if (confirm('¬øEliminar este alumno y todos sus datos?')) {
            alumnos = alumnos.filter(a => a.id !== id);
            delete notas[id];
            if (seleccionado && seleccionado.id === id) {
                seleccionado = null;
            }
            guardarEnFirebase();
            renderizar();
        }
    }

    function seleccionarAlumno(id) {
        seleccionado = alumnos.find(a => a.id === id);
        semanaActual = 1;
        renderizar();
    }

    function cambiarSemana(s) {
        semanaActual = s;
        renderizar();
    }

    function toggleCategoria(cat) {
        categoriaExpandida = categoriaExpandida === cat ? null : cat;
        renderizar();
    }

    function asignarTaller(taller) {
        if (!seleccionado) return;
        const alumno = alumnos.find(a => a.id === seleccionado.id);
        alumno.seg['s' + semanaActual].taller = taller;
        alumno.seg['s' + semanaActual].tareaAsignada = null;
        seleccionado = alumno;
        guardarEnFirebase();
        renderizar();
    }

    function asignarTareaSemana(tareaId) {
        if (!seleccionado) return;
        const alumno = alumnos.find(a => a.id === seleccionado.id);
        alumno.seg['s' + semanaActual].tareaAsignada = tareaId ? parseInt(tareaId) : null;
        seleccionado = alumno;
        guardarEnFirebase();
        renderizar();
    }

    function actualizarValor(cat, idx, dia, valor) {
        if (!seleccionado) return;
        const alumno = alumnos.find(a => a.id === seleccionado.id);
        alumno.seg['s' + semanaActual].dias['d' + dia][cat][idx] = valor;
        seleccionado = alumno;
        guardarEnFirebase();
    }

    function actualizarTarea(criterioIdx, dia, valor) {
        if (!seleccionado) return;
        const alumno = alumnos.find(a => a.id === seleccionado.id);
        alumno.seg['s' + semanaActual].dias['d' + dia].tarea[criterioIdx] = valor;
        seleccionado = alumno;
        guardarEnFirebase();
    }

    function agregarNota() {
        const input = document.getElementById('nota-nueva');
        const texto = input.value.trim();
        
        if (!texto || !seleccionado) return;

        if (!notas[seleccionado.id]) {
            notas[seleccionado.id] = [];
        }

        notas[seleccionado.id].push({
            txt: texto,
            fecha: new Date().toLocaleDateString(),
            sem: semanaActual
        });

        input.value = '';
        guardarEnFirebase();
        renderizar();
    }

    function generarComentario(hastaS) {
        if (!seleccionado) return '';
        const al = seleccionado;
        let txt = al.nombre + '\n';
        txt += (hastaS === 4 ? 'EVALUACI√ìN MENSUAL' : 'SEMANA ' + hastaS) + '\n';
        txt += '='.repeat(60) + '\n\n';
        txt += 'Comentario generado autom√°ticamente.\n';
        txt += 'Sistema de seguimiento con sincronizaci√≥n en tiempo real.\n';
        return txt;
    }

    function mostrarComentario(hastaS) {
        const texto = generarComentario(hastaS);
        document.getElementById('texto-comentario').textContent = texto;
        document.getElementById('modal-comentario').classList.add('show');
    }

    function cerrarModal() {
        document.getElementById('modal-comentario').classList.remove('show');
    }

    function copiarComentario() {
        const texto = document.getElementById('texto-comentario').textContent;
        navigator.clipboard.writeText(texto).then(() => {
            alert('‚úÖ Comentario copiado');
        });
    }

    function exportar() {
        if (alumnos.length === 0) return;
        let contenido = 'EVALUACIONES - ROTACI√ìN DE TALLERES\n';
        contenido += 'Generado el: ' + new Date().toLocaleDateString() + '\n\n';
        alumnos.forEach(alumno => {
            contenido += alumno.nombre + '\n' + '='.repeat(40) + '\n\n';
        });
        const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'evaluaciones_' + new Date().toISOString().split('T')[0] + '.txt';
        link.click();
        URL.revokeObjectURL(url);
    }

    function renderizar() {
        document.getElementById('contador-alumnos').textContent = alumnos.length + ' alumnos';
        document.getElementById('btn-exportar').disabled = alumnos.length === 0;

        const listaAlumnos = document.getElementById('lista-alumnos');
        if (alumnos.length === 0) {
            listaAlumnos.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px; font-size: 13px;">No hay alumnos</p>';
        } else {
            listaAlumnos.innerHTML = alumnos.map(a => `
                <button class="alumno-btn ${seleccionado && seleccionado.id === a.id ? 'active' : ''}"
                        onclick="seleccionarAlumno(${a.id})">
                    ${a.nombre}
                </button>
            `).join('');
        }

        const contentArea = document.getElementById('content-area');
        
        if (!seleccionado) {
            contentArea.innerHTML = `
                <div class="content-area">
                    <div class="placeholder">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p>Selecciona un alumno para comenzar</p>
                    </div>
                </div>
            `;
            return;
        }

        const tallerAsignado = seleccionado.seg['s' + semanaActual].taller;
        const tareaAsignada = seleccionado.seg['s' + semanaActual].tareaAsignada;
        const tareaObj = tareaAsignada ? tareas.find(t => t.id === tareaAsignada) : null;
        const tareasDelTaller = tallerAsignado ? tareas.filter(t => t.taller === tallerAsignado) : [];

        let html = `
            <div>
                <div class="content-area">
                    <div class="alumno-header">
                        <div class="alumno-info">
                            <h2>${seleccionado.nombre}</h2>
                            <p>Rotaci√≥n por Talleres</p>
                        </div>
                        <button class="btn btn-delete" onclick="eliminarAlumno(${seleccionado.id})">üóëÔ∏è Eliminar</button>
                    </div>

                    <div class="semanas-nav">
                        ${[1,2,3,4].map(s => `
                            <button class="semana-btn ${semanaActual === s ? 'active' : ''}" 
                                    onclick="cambiarSemana(${s})">
                                Semana ${s}
                            </button>
                        `).join('')}
                    </div>

                    <div class="rotacion-section">
                        <label class="rotacion-label">üîÑ Taller de esta semana:</label>
                        <select class="rotacion-select" onchange="asignarTaller(this.value)">
                            <option value="">-- Seleccionar taller --</option>
                            ${talleres.map(t => `
                                <option value="${t}" ${tallerAsignado === t ? 'selected' : ''}>${t}</option>
                            `).join('')}
                        </select>

                        ${tallerAsignado && tareasDelTaller.length > 0 ? `
                            <div class="tarea-select-section">
                                <label class="tarea-select-label">üìã Tarea asignada:</label>
                                <select class="tarea-select" onchange="asignarTareaSemana(this.value)">
                                    <option value="">-- Sin tarea --</option>
                                    ${tareasDelTaller.map(t => `
                                        <option value="${t.id}" ${tareaAsignada === t.id ? 'selected' : ''}>${t.nombre}</option>
                                    `).join('')}
                                </select>
                            </div>
                        ` : ''}
                    </div>

                    <div class="dias-header">
                        ${[1,2,3,4,5].map(d => `<div class="dia-label">D√≠a ${d}</div>`).join('')}
                    </div>

                    ${aspectosData.map(cat => `
                        <div class="categoria">
                            <div class="categoria-header" onclick="toggleCategoria('${cat.categoria}')">
                                <span>${cat.titulo}</span>
                                <span>${categoriaExpandida === cat.categoria ? '‚ñº' : '‚ñ∂'}</span>
                            </div>
                            <div class="categoria-content ${categoriaExpandida === cat.categoria ? 'expanded' : ''}">
                                ${cat.items.map((item, idx) => `
                                    <div class="aspecto">
                                        <div class="aspecto-nombre">${item.nombre}</div>
                                        <div class="aspecto-dias">
                                            ${[1,2,3,4,5].map(d => `
                                                <select onchange="actualizarValor('${cat.categoria}', ${idx}, ${d}, this.value)">
                                                    ${item.opciones.map(op => `
                                                        <option value="${op}" ${seleccionado.seg['s' + semanaActual].dias['d' + d][cat.categoria][idx] === op ? 'selected' : ''}>
                                                            ${op || '-'}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="notas-section">
                    <h3>üìù Notas adicionales</h3>
                    <div class="notas-input">
                        <input type="text" id="nota-nueva" placeholder="A√±adir una nota..." 
                               onkeypress="if(event.key==='Enter')agregarNota()">
                        <button class="btn btn-primary" onclick="agregarNota()">A√±adir</button>
                    </div>
                    <div class="notas-lista">
                        ${(notas[seleccionado.id] || []).map(n => `
                            <div class="nota-item">
                                <div>${n.txt}</div>
                                <div class="nota-fecha">Semana ${n.sem} - ${n.fecha}</div>
                            </div>
                        `).join('') || '<p style="text-align: center; color: #6b7280;">No hay notas</p>'}
                    </div>
                </div>

                <div class="comentarios-section">
                    <div class="comentarios-btns">
                        <button class="btn-comentario" onclick="mostrarComentario(${semanaActual})">
                            üìÑ Comentario Semana ${semanaActual}
                        </button>
                        <button class="btn-comentario mensual" onclick="mostrarComentario(4)">
                            üìã Comentario Mensual
                        </button>
                    </div>
                </div>
            </div>
        `;

        contentArea.innerHTML = html;
    }
</script>
```

</body>
</html>
